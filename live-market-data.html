<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Market Pulse + R-Factor Strategy</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      padding: 40px 20px;
    } 
    .main-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 550px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      background: #007bff;
      color: white;
      padding: 16px 20px;
      font-size: 1.4rem;
      font-weight: bold;
      text-align: center;
    }
    .filter-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      gap: 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }
    select {
      padding: 6px 10px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .table-container {
      max-height: 480px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }
    th {
      position: sticky;
      top: 0;
      background: #007bff;
      color: white;
      z-index: 2;
      cursor: pointer;
      user-select: none;
    }
    th.sort-asc::after {
      content: " ðŸ”¼";
    }
    th.sort-desc::after {
      content: " ðŸ”½";
    }
    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }
    tbody tr:hover {
      background: #e6f0ff;
      cursor: pointer;
    }
    td.green {
      color: #28a745;
      font-weight: bold;
    }
    td.red {
      color: #dc3545;
      font-weight: bold;
    }
    .footer {
      text-align: center;
      padding: 8px;
      font-size: 0.85rem;
      color: #555;
      background: #f8f9fa;
      border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- ðŸ”µ Live Market Pulse Box -->
    <div class="container">
      <div class="header">Live Market Pulse</div>
      <div class="filter-bar">
        <label for="trendFilter">Filter:</label>
        <select id="trendFilter" onchange="applyFilter()">
          <option value="neutral">All</option>
          <option value="bullish">Bullish (Positive %)</option>
          <option value="bearish">Bearish (Negative %)</option>
        </select>
      </div>
      <div class="table-container">
        <table id="marketTable">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Param 01</th>
              <th>Prev Close</th>
              <th>Current %</th>
              <th>RFactor</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer" id="marketUpdated">Last updated: --</div>
    </div>

    <!-- ðŸŸ¢ R-Factor Strategy Box -->
    <div class="container">
      <div class="header">R-Factor Strategy</div>
      <div class="filter-bar">
        <label for="strategyFilter">Filter:</label>
        <select id="strategyFilter" onchange="applyStrategyFilter()">
          <option value="all">All</option>
          <option value="strong">Strong Momentum</option>
          <option value="weak">Weak Momentum</option>
        </select>
      </div>
      <div class="table-container">
        <table id="rFactorTable">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Latest R-Factor</th>
              <th>% Change</th>
              <th>Score</th>
              <th>Time</th> <!-- ðŸ•’ Added timestamp column -->
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer" id="rFactorUpdated">Last updated: --</div>
    </div>
  </div>

  <!-- SockJS + STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <script>
    const socket = new SockJS('http://localhost:8080/live-data-websocket');
    const stompClient = Stomp.over(socket);

    let marketData = [];
    let rFactorData = [];
    let currentSort = { column: null, direction: 'desc' };

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);

      // ðŸŸ¦ Live Market Pulse Subscription
      stompClient.subscribe('/topic/liveData', function(message) {
        marketData = JSON.parse(message.body);
        applyFilter();
        document.getElementById('marketUpdated').textContent =
          "Last updated: " + new Date().toLocaleTimeString();
      });

      // ðŸŸ© R-Factor Strategy Subscription
      stompClient.subscribe('/topic/rFactorStrategy', function(message) {
        rFactorData = JSON.parse(message.body);
        applyStrategyFilter();
        document.getElementById('rFactorUpdated').textContent =
          "Last updated: " + new Date().toLocaleTimeString();
      });
    });

    // ðŸ”µ Live Market Pulse
    function applyFilter() {
      const filter = document.getElementById('trendFilter').value;
      let filtered = marketData;

      if (filter === 'bullish')
        filtered = marketData.filter(i => i.currentPercentage > 0);
      else if (filter === 'bearish')
        filtered = marketData.filter(i => i.currentPercentage < 0);

      filtered.sort((a, b) => b.rfactor - a.rfactor);
      updateMarketTable(filtered);
    }

    function updateMarketTable(data) {
      const tbody = document.querySelector("#marketTable tbody");
      tbody.innerHTML = "";
      data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.symbol}</td>
          <td>${item.param_01}</td>
          <td>${item.previousClose}</td>
          <td class="${item.currentPercentage >= 0 ? 'green' : 'red'}">${item.currentPercentage}%</td>
          <td>${item.rfactor}</td>
        `;
       
        row.addEventListener("click", () =>
  window.open(`https://www.tradingview.com/chart/?symbol=NSE%3A${encodeURIComponent(item.symbol)}&interval=5`, "_blank")
);

        tbody.appendChild(row);
      });
    }

    // ðŸŸ© R-Factor Strategy Table with Sorting
    function applyStrategyFilter() {
      const filter = document.getElementById('strategyFilter').value;
      let filtered = rFactorData;

      if (filter === 'strong')
        filtered = filtered.filter(i => i.percentChange > 0);
      else if (filter === 'weak')
        filtered = filtered.filter(i => i.percentChange < 0);

      sortRFactorData(filtered);
      updateRFactorTable(filtered);
    }

    function sortRFactorData(data) {
      const { column, direction } = currentSort;
      if (!column) return;

      data.sort((a, b) => {
        let valA = a[column];
        let valB = b[column];
        if (column === 'timestamp') {
          valA = new Date(a.timestamp).getTime();
          valB = new Date(b.timestamp).getTime();
        }
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function updateRFactorTable(data) {
      const tbody = document.querySelector("#rFactorTable tbody");
      tbody.innerHTML = "";
      data.forEach(item => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleTimeString('en-IN', { hour12: true });

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.symbol}</td>
          <td>${item.latestRFactor?.toFixed(2) ?? '-'}</td>
          <td class="${item.percentChange >= 0 ? 'green' : 'red'}">
            ${item.percentChange?.toFixed(2) ?? 0}%
          </td>
          <td>${item.combinedScore?.toFixed(3) ?? '-'}</td>
          <td>${timeStr}</td>
        `;
        row.addEventListener("click", () =>
window.open(`https://www.tradingview.com/chart/?symbol=NSE%3A${encodeURIComponent(item.symbol)}&interval=5`, "_blank")        );
        tbody.appendChild(row);
      });
      updateSortIndicators();
    }

    // ðŸ§­ Sorting Header Clicks
    document.addEventListener("DOMContentLoaded", () => {
      const headers = document.querySelectorAll("#rFactorTable thead th");
      const columns = ["symbol", "latestRFactor", "percentChange", "combinedScore", "timestamp"];

      headers.forEach((th, index) => {
        th.addEventListener("click", () => {
          const columnKey = columns[index];

          if (currentSort.column === columnKey) {
            currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
          } else {
            currentSort.column = columnKey;
            currentSort.direction = "asc";
          }

          applyStrategyFilter();
        });
      });
    });

    function updateSortIndicators() {
      const headers = document.querySelectorAll("#rFactorTable thead th");
      headers.forEach((th, i) => th.classList.remove("sort-asc", "sort-desc"));
      if (!currentSort.column) return;
      const columns = ["symbol", "latestRFactor", "percentChange", "combinedScore", "timestamp"];
      const index = columns.indexOf(currentSort.column);
      if (index >= 0) {
        headers[index].classList.add(currentSort.direction === "asc" ? "sort-asc" : "sort-desc");
      }
    }
  </script>
</body>
</html>
